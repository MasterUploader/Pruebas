using Logging.Abstractions;
using Logging.Helpers;
using Microsoft.AspNetCore.Mvc.Controllers;
using Microsoft.AspNetCore.Mvc.Filters;
using System;
using System.Linq;
using System.Text.Json;
using System.Threading.Tasks;

namespace Logging.Filters
{
    /// <summary>
    /// Filtro de acci贸n que intercepta la ejecuci贸n de los controladores
    /// y registra autom谩ticamente el flujo de m茅todos, los par谩metros de entrada y salida.
    /// </summary>
    public class LoggingActionFilter : IAsyncActionFilter
    {
        private readonly ILoggingService _loggingService;

        /// <summary>
        /// Constructor que recibe el servicio de logging.
        /// </summary>
        public LoggingActionFilter(ILoggingService loggingService)
        {
            _loggingService = loggingService;
        }

        /// <summary>
        /// M茅todo que intercepta la ejecuci贸n de una acci贸n en un controlador.
        /// Captura la entrada, la salida y las excepciones.
        /// </summary>
        public async Task OnActionExecutionAsync(ActionExecutingContext context, ActionExecutionDelegate next)
        {
            var controllerName = ((ControllerActionDescriptor)context.ActionDescriptor).ControllerName;
            var actionName = ((ControllerActionDescriptor)context.ActionDescriptor).ActionName;
            var methodFullName = $"{controllerName}.{actionName}";

            //  Capturar par谩metros de entrada
            var inputParams = context.ActionArguments.Any()
                ? JsonSerializer.Serialize(context.ActionArguments, new JsonSerializerOptions { WriteIndented = true })
                : "Sin par谩metros.";

            _loggingService.AddMethodEntryLog(methodFullName, inputParams);

            //  Continuar con la ejecuci贸n del m茅todo
            var executedContext = await next();

            if (executedContext.Exception == null)
            {
                //  Capturar resultado si no hay excepci贸n
                var returnValue = executedContext.Result?.ToString() ?? "Sin retorno (void).";
                _loggingService.AddMethodExitLog(methodFullName, returnValue);
            }
            else
            {
                //  Capturar excepciones
                _loggingService.AddExceptionLog(executedContext.Exception);
            }
        }
    }
}
