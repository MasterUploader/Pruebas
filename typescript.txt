import { Component, OnInit } from '@angular/core';
import { HttpClient } from '@angular/common/http';

@Component({
  selector: 'app-mi-pagina',
  templateUrl: './mi-pagina.component.html',
  styleUrls: ['./mi-pagina.component.css']
})
export class MiPaginaComponent implements OnInit {

  agenciaApertura: string;
  agenciaImprime: string;
  tarjeta: any;
  datosTarjeta: any[];
  tarjetaSeleccionada: any;

  constructor(private http: HttpClient) { }

  ngOnInit(): void {
    this.consultarMicroservicio();
  }

  consultarMicroservicio() {
    const url = `https://api.ejemplo.com/tarjeta?bin=1234567890&codigoAgenciaApertura=123&codigoAgenciaImprime=456`;

    this.http.get(url).subscribe((response: any) => {
      this.agenciaApertura = response.agenciaApertura;
      this.agenciaImprime = response.agenciaImprime;
      this.tarjeta = response.tarjeta;
      this.datosTarjeta = response.tarjeta.detalles;
    });
  }

  seleccionarFila(tarjeta: any) {
    this.tarjetaSeleccionada = tarjeta;
  }

  imprimir() {
    const printData = this.getPrintData();
    this.printData(printData);
  }

  getPrintData(): any {
    return {
      nombre: {
        text: 'Nombre:',
        x: 10,
        y: 10,
        fontSize: 12,
        bold: true,
      },
      numero: {
        text: 'Número:',
        x: 10,
        y: 30,
        fontSize: 10,
      },
      fechaVencimiento: {
        text: 'Fecha de vencimiento:',
        x: 10,
        y: 50,
        fontSize: 10,
      },
    };
  }

  printData(printData: any) {
    const printWindow = window.open('', 'PRINT', 'width=500,height=500');
    const printDocument = printWindow.document;

    printDocument.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Impresión de tarjeta</title>
          <style>
            body {
              font-family: sans-serif;
              font-size: 10px;
            }
          </style>
        </head>
        <body>
    `);

    for (const key in printData) {
      const data = printData[key];
      printDocument.write(`
        <p style="
          position: absolute;
          left: ${data.x}px;
          top: ${data.y}px;
          font-size: ${data.fontSize}px;
          ${data.bold ? 'font-weight: bold;' : ''}
        ">${data.text}</p>
      `);
    }

    printDocument.write(`</body></html>`);

    printWindow.onload = function() {
      printWindow.print();
      printWindow.close();
    };
  }
}
